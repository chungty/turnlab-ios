default_platform(:ios)

platform :ios do
  desc "Create In-App Purchase"
  lane :create_iap do
    app_store_connect_api_key(
      key_id: "22C7AGK59G",
      issuer_id: "a81eb7c9-e210-4c68-bc19-e43b8ddc986c",
      key_filepath: File.expand_path("~/Downloads/AuthKey_22C7AGK59G.p8")
    )

    # Note: Fastlane doesn't have a built-in action for creating IAPs
    # You need to use the App Store Connect web interface or use spaceship directly
    UI.message("IAP creation needs to be done via App Store Connect web interface")
    UI.message("Product ID: com.turnlab.premium")
    UI.message("Type: Non-Consumable")
    UI.message("Price: $4.99 (Tier 5)")
  end

  desc "Build and archive the app"
  lane :archive do
    app_store_connect_api_key(
      key_id: "22C7AGK59G",
      issuer_id: "a81eb7c9-e210-4c68-bc19-e43b8ddc986c",
      key_filepath: File.expand_path("~/Downloads/AuthKey_22C7AGK59G.p8")
    )

    build_app(
      scheme: "TurnLab",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "TurnLab.ipa",
      clean: true
    )
  end

  desc "Upload to App Store Connect"
  lane :upload do
    app_store_connect_api_key(
      key_id: "22C7AGK59G",
      issuer_id: "a81eb7c9-e210-4c68-bc19-e43b8ddc986c",
      key_filepath: File.expand_path("~/Downloads/AuthKey_22C7AGK59G.p8")
    )

    upload_to_app_store(
      ipa: "./build/TurnLab.ipa",
      skip_metadata: true,
      skip_screenshots: true,
      precheck_include_in_app_purchases: false
    )
  end

  desc "Full release: archive and upload"
  lane :release do
    archive
    upload
  end

  desc "Upload metadata and screenshots only (no binary)"
  lane :upload_metadata do
    app_store_connect_api_key(
      key_id: "22C7AGK59G",
      issuer_id: "a81eb7c9-e210-4c68-bc19-e43b8ddc986c",
      key_filepath: File.expand_path("~/Downloads/AuthKey_22C7AGK59G.p8")
    )

    deliver(
      skip_binary_upload: true,
      skip_metadata: false,
      skip_screenshots: false,
      skip_app_version_update: false,
      force: true,
      precheck_include_in_app_purchases: false,
      submit_for_review: false,
      ignore_language_directory_validation: false,
      overwrite_screenshots: true,
      app_rating_config_path: "./fastlane/metadata/rating_config.json",
      primary_category: "SPORTS",
      secondary_category: "EDUCATION"
    )
  end

  desc "Upload metadata only (no screenshots, no binary)"
  lane :upload_metadata_only do
    app_store_connect_api_key(
      key_id: "22C7AGK59G",
      issuer_id: "a81eb7c9-e210-4c68-bc19-e43b8ddc986c",
      key_filepath: File.expand_path("~/Downloads/AuthKey_22C7AGK59G.p8")
    )

    deliver(
      skip_binary_upload: true,
      skip_metadata: false,
      skip_screenshots: true,
      skip_app_version_update: false,
      force: true,
      precheck_include_in_app_purchases: false,
      submit_for_review: false,
      app_rating_config_path: "./fastlane/metadata/rating_config.json",
      primary_category: "SPORTS",
      secondary_category: "EDUCATION"
    )
  end

  desc "Upload metadata without review info (workaround for first submission)"
  lane :upload_metadata_safe do
    app_store_connect_api_key(
      key_id: "22C7AGK59G",
      issuer_id: "a81eb7c9-e210-4c68-bc19-e43b8ddc986c",
      key_filepath: File.expand_path("~/Downloads/AuthKey_22C7AGK59G.p8")
    )

    # First upload screenshots only
    deliver(
      skip_binary_upload: true,
      skip_metadata: true,
      skip_screenshots: false,
      force: true,
      overwrite_screenshots: true,
      precheck_include_in_app_purchases: false,
      submit_for_review: false
    )

    # Then upload metadata without screenshots
    deliver(
      skip_binary_upload: true,
      skip_metadata: false,
      skip_screenshots: true,
      skip_app_version_update: true,
      force: true,
      precheck_include_in_app_purchases: false,
      submit_for_review: false,
      app_rating_config_path: "./fastlane/metadata/rating_config.json",
      primary_category: "SPORTS",
      secondary_category: "EDUCATION"
    )
  end

  desc "Submit app for App Store review"
  lane :submit_for_review do
    api_key = app_store_connect_api_key(
      key_id: "22C7AGK59G",
      issuer_id: "a81eb7c9-e210-4c68-bc19-e43b8ddc986c",
      key_filepath: File.expand_path("~/Downloads/AuthKey_22C7AGK59G.p8")
    )

    deliver(
      api_key: api_key,
      skip_binary_upload: true,
      skip_metadata: true,
      skip_screenshots: true,
      force: true,
      precheck_include_in_app_purchases: false,
      submit_for_review: true,
      automatic_release: true,
      phased_release: false
    )
  end

  desc "Upload to TestFlight"
  lane :upload_testflight do
    app_store_connect_api_key(
      key_id: "22C7AGK59G",
      issuer_id: "a81eb7c9-e210-4c68-bc19-e43b8ddc986c",
      key_filepath: File.expand_path("~/Downloads/AuthKey_22C7AGK59G.p8")
    )

    upload_to_testflight(
      ipa: "./build/TurnLab.ipa",
      skip_waiting_for_build_processing: true
    )
  end

  desc "Build and upload to TestFlight"
  lane :beta do
    archive
    upload_testflight
  end

  desc "Create app store submission"
  lane :create_submission do
    api_key = app_store_connect_api_key(
      key_id: "22C7AGK59G",
      issuer_id: "a81eb7c9-e210-4c68-bc19-e43b8ddc986c",
      key_filepath: File.expand_path("~/Downloads/AuthKey_22C7AGK59G.p8")
    )

    require 'spaceship'

    app = Spaceship::ConnectAPI::App.find("com.turnlab.app")
    UI.message("App: #{app.name}")

    version = app.get_edit_app_store_version
    UI.message("Version: #{version.version_string}")
    UI.message("State: #{version.app_store_state}")

    # List available methods
    UI.message("Available methods on version: #{version.methods.grep(/submit/).join(', ')}")

    begin
      # Try create_app_store_version_submission
      version.create_app_store_version_submission
      UI.success("✅ Submitted for review!")
    rescue NoMethodError => e
      UI.message("create_app_store_version_submission not available, trying alternative...")
      begin
        # Try submit_for_review method
        version.submit_for_review
        UI.success("✅ Submitted for review!")
      rescue => e2
        UI.error("Error: #{e2.message}")
      end
    rescue => e
      UI.error("Error: #{e.message}")
    end
  end

  desc "Check and cancel review submission"
  lane :cancel_review do
    app_store_connect_api_key(
      key_id: "22C7AGK59G",
      issuer_id: "a81eb7c9-e210-4c68-bc19-e43b8ddc986c",
      key_filepath: File.expand_path("~/Downloads/AuthKey_22C7AGK59G.p8")
    )

    require 'spaceship'

    app = Spaceship::ConnectAPI::App.find("com.turnlab.app")
    UI.message("App: #{app.name}")

    version = app.get_edit_app_store_version
    if version
      UI.message("Version: #{version.version_string}")
      UI.message("State: #{version.app_store_state}")

      # Try to get any pending submission
      begin
        submission = version.fetch_app_store_version_submission
        if submission
          UI.message("Found submission with state: #{submission.attributes}")
          UI.message("Cancelling submission...")
          submission.delete!
          UI.success("Submission cancelled!")
        else
          UI.message("No pending submission found")
        end
      rescue => e
        UI.message("Could not fetch submission: #{e.message}")
      end

      if version.app_store_state == "WAITING_FOR_REVIEW"
        UI.message("Cancelling via version...")
        version.cancel_submission rescue nil
        UI.success("Review cancelled!")
      elsif version.app_store_state == "IN_REVIEW"
        UI.error("App is IN_REVIEW - cannot cancel once review has started")
      else
        UI.message("Current state: #{version.app_store_state}")
      end
    else
      UI.error("No edit version found")
    end
  end
end
